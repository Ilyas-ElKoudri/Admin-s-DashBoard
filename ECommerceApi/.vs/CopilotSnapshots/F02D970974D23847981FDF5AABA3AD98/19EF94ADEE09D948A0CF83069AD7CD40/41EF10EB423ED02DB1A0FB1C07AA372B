using ECommerceApi.Data;
using Microsoft.EntityFrameworkCore;

// Creates a new web application builder for an ASP.NET Core app.
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

var app = builder.Build();

// Configure the HTTP request pipeline in the correct order:

// 1. Exception Handling (should be first)
if (app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/error");
}
else
{
    app.UseExceptionHandler("/error");
    // 2. HSTS (only in production)
    app.UseHsts();
}

// 3. HTTPS Redirection
app.UseHttpsRedirection();

// 4. Static Files (if you have any, keep this here)
// app.UseStaticFiles();

// 5. Routing
app.UseRouting();

// 6. Authentication (if you add authentication in the future)
// app.UseAuthentication();

// 7. Authorization
app.UseAuthorization();

// 8. Swagger (only in development)
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// 9. Endpoint Mapping
app.MapControllers();

// 10. Run the app
app.Run();